<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	xmlns:georss="http://www.georss.org/georss" xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#" xmlns:media="http://search.yahoo.com/mrss/"
	>

<channel>
	<title>python &#8211; Kshitij Kulshrestha</title>
	<atom:link href="https://kshitij-kuls.com/category/blogs/technical/python/feed/" rel="self" type="application/rss+xml" />
	<link>https://kshitij-kuls.com</link>
	<description>A DREAM WITHOUT A GOAL IS JUST A DREAM</description>
	<lastBuildDate>Sun, 13 Oct 2019 03:43:16 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>http://wordpress.com/</generator>

<image>
	<url>https://kshitijkuls.files.wordpress.com/2018/01/cropped-whatsapp-image-2018-01-04-at-21-23-55.jpeg?w=32</url>
	<title>python &#8211; Kshitij Kulshrestha</title>
	<link>https://kshitij-kuls.com</link>
	<width>32</width>
	<height>32</height>
</image> 
<cloud domain='kshitij-kuls.com' port='80' path='/?rsscloud=notify' registerProcedure='' protocol='http-post' />
<atom:link rel="search" type="application/opensearchdescription+xml" href="https://kshitij-kuls.com/osd.xml" title="Kshitij Kulshrestha" />
	<atom:link rel='hub' href='https://kshitij-kuls.com/?pushpress=hub'/>
	<item>
		<title>Setting up Virtual Environment for Pyspark or any other clustered env</title>
		<link>https://kshitij-kuls.com/2019/08/04/setting-up-virtual-environment-for-pyspark/</link>
					<comments>https://kshitij-kuls.com/2019/08/04/setting-up-virtual-environment-for-pyspark/#respond</comments>
		
		<dc:creator><![CDATA[Kshitij Kulshrestha]]></dc:creator>
		<pubDate>Sun, 04 Aug 2019 02:59:49 +0000</pubDate>
				<category><![CDATA[python]]></category>
		<category><![CDATA[Virtual Environment]]></category>
		<category><![CDATA[dynload]]></category>
		<category><![CDATA[pyspark]]></category>
		<category><![CDATA[spark]]></category>
		<guid isPermaLink="false">http://kshitij-kuls.com/?p=307</guid>

					<description><![CDATA[On clustered environment, we face lot of issues with the python version available on the nodes, if we are shipping our product in that case we had to perform lot of sanity test pre-deployment to make sure our application will run as per our expectation but we can&#8217;t cover all scenarios and hence there is... <a class="more-link" href="https://kshitij-kuls.com/2019/08/04/setting-up-virtual-environment-for-pyspark/#more-307">Continue Reading &#8594;</a>]]></description>
										<content:encoded><![CDATA[<div>
<div class="sc-dTdPqK DYtDj">
<div id="content" class="page view">
<div id="main-content" class="wiki-content">
<p>On clustered environment, we face lot of issues with the python version available on the nodes, if we are shipping our product in that case we had to perform lot of sanity test pre-deployment to make sure our application will run as per our expectation but we can&#8217;t cover all scenarios and hence there is high chance of hitting issue.</p>
</div>
<p>So we thought of a better way and come up with an idea of shipping our own python version with everything preinstalled in that package, everyone might have been familiar with <strong>Virtual Environment or Anaconda </strong>but believe me after reading this you would get something new to learn.</p>
<div id="main-content" class="wiki-content">
<p><span id="more-307"></span>Before we proceed it&#8217;s require to understand the basic structure of python:</p>
<p>├── bin<br />
│ ├── activate<br />
│ ├── activate.csh<br />
│ ├── activate.fish<br />
│ ├── activate_this.py<br />
│ ├── easy_install<br />
│ ├── easy_install-3.6<br />
│ ├── pip<br />
│ ├── pip3<br />
│ ├── pip3.6<br />
│ ├── python<br />
│ ├── python-config<br />
│ ├── python3 -&gt; python<br />
│ ├── python3.6 -&gt; python<br />
│ └── wheel<br />
├── include<br />
│ └── python3.6m -&gt; /usr/include/python3.6m<br />
├── lib<br />
│ └── python3.6<br />
| ├── site-packages<br />
│ ├── lib-dynload -&gt; /usr/lib/python3.6/lib-dynload [Dynamic Library]</p>
<p><em><u><strong>Environment Variables:</strong></u></em></p>
<p><strong>PYSPARK_PYTHON : Points to the executable python file: bin/python</strong></p>
<p><strong>LD_LIBRARY_PATH : Points to the dynamic library path: lib/python3.6/lib-dynload [All .so* files]</strong></p>
<p><strong>PYTHONPATH : Points to the installed packages within virtual environment as well as the dynamic library path : lib/python3.6/site-packages&lt;CPS&gt;lib/python3.6/lib-dynload [All .py files]</strong></p>
<p><strong>PYTHONHOME : Points to the python library path: lib/python3.6/site-packages</strong></p>
<p>Steps to build Virtual environment:</p>
<ol>
<li>Install python in the machine of desired version.</li>
<li>
<div class="code panel pdl conf-macro output-block">
<div class="codeHeader panelHeader pdl"><b>Create Virtual Env</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_262334" class="syntaxhighlighter sh-confluence nogutter  py">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="py plain">virtualenv env </code><code class="py keyword">-</code><code class="py plain">p </code><code class="py keyword">/</code><code class="py plain">usr</code><code class="py keyword">/</code><code class="py plain">local</code><code class="py keyword">/</code><code class="py functions">bin</code><code class="py keyword">/</code><code class="py plain">python3</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
<li>
<div class="code panel pdl conf-macro output-block">
<div class="codeHeader panelHeader pdl"><b>Activate Virtual Env</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_195203" class="syntaxhighlighter sh-confluence nogutter  py">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="py plain">source env</code><code class="py keyword">/</code><code class="py functions">bin</code><code class="py keyword">/</code><code class="py plain">activate</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
<li>
<div class="code panel pdl conf-macro output-block">
<div class="codeHeader panelHeader pdl"><b>Install requirements</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_304113" class="syntaxhighlighter sh-confluence nogutter  py">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="py plain">pip install numpy</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
<li>Now here is the trick, you can see this line ├── lib-dynload -&gt; /usr/lib/python3.6/lib-dynload it&#8217;s a symbolic link and pointing to the local machine path and hence even if you just zip this virtual environment folder then these dependencies would be missing on the cluster.</li>
<li>So, it&#8217;s required to copy all the <em><u><strong>.so*</strong></u></em> files from /usr/lib/python3.6/lib-dynload, /usr/lib64/*.so.*, etc&#8230; to <strong>lib/python3.6/lib-dynload </strong> [Be careful about  /usr/lib64/*.so.*, it does contain os specific libs, which may fail on different os versions, hence try to avoid so files from this specific folder].</li>
<li>Copy all the <em><u><strong>.py</strong></u></em>files from /usr/lib/python3.6/lib-dynload, /usr/lib64/*.so.*, etc&#8230; to <strong>lib/python3.6/site-packages.</strong></li>
<li>
<p class="auto-cursor-target">Run it from the home dir of virtual environment in our case it&#8217;s <strong>env/</strong></p>
<div class="code panel pdl conf-macro output-block">
<div class="codeHeader panelHeader pdl"><b>Prepare zip</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_332454" class="syntaxhighlighter sh-confluence nogutter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">zip -rq ..</code><code class="bash plain">/venv</code><code class="bash plain">.zip *</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
</ol>
<p><u><em><strong>Environmental variable setup</strong></em></u></p>
<p>For <strong>driver</strong>: spark.yarn.appMasterEnv.[Environment variable]</p>
<p>For <strong>executor</strong>: spark.executorEnv.[Environment variable]</p>
<p><strong>PYSPARK_PYTHON</strong></p>
<ol>
<li class="col-md-3">pyspark.spark.yarn.appMasterEnv.PYSPARK_PYTHON = venv/bin/python</li>
<li class="col-md-3">
<div class="col-md-3">pyspark.spark.executorEnv.PYSPARK_PYTHON = venv/bin/python</div>
</li>
</ol>
<p><strong>PYTHONHOME</strong></p>
<ol>
<li>
<div class="col-md-3">pyspark.spark.yarn.appMasterEnv.PYTHONHOME = venv/lib64/python3.6/site-packages</div>
</li>
<li>
<div class="col-md-3">pyspark.spark.executorEnv.PYTHONHOME = venv/lib64/python3.6/site-packages</div>
</li>
</ol>
<p><strong>LD_LIBRARY_PATH</strong></p>
<ol>
<li>
<div class="col-md-3">pyspark.spark.yarn.appMasterEnv.LD_LIBRARY_PATH = venv/lib64/python3.6/lib-dynload</div>
</li>
<li>
<div class="col-md-3">pyspark.spark.executorEnv.LD_LIBRARY_PATH = venv/lib64/python3.6/lib-dynload</div>
</li>
</ol>
<p><strong>PYTHONPATH</strong></p>
<p>This need to included in <strong>YARN-ENV-ENTRIES</strong>, it&#8217;s not getting set from the spark configs.</p>
<p>PYTHONPATH = {{PWD}}/__venv__.zip&lt;CPS&gt;{{PWD}}/__py4j-0.10.7-src__.zip&lt;CPS&gt;venv/lib64/python3.6/site-packages&lt;CPS&gt;venv/lib64/python3.6/lib-dynload&lt;CPS&gt;</p>
<div class="code panel pdl conf-macro output-block">
<div class="codeHeader panelHeader pdl"><b>To run python</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_796347" class="syntaxhighlighter sh-confluence nogutter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash functions">cd</code> <code class="bash plain">venv</code></div>
<div class="line number2 index1 alt1"></div>
<div class="line number3 index2 alt2"><code class="bash functions">export</code> <code class="bash plain">PYTHONPATH=lib64</code><code class="bash plain">/python3</code><code class="bash plain">.6</code><code class="bash plain">/site-packages</code><code class="bash plain">:lib64</code><code class="bash plain">/python3</code><code class="bash plain">.6</code><code class="bash plain">/lib-dynload/</code></div>
<div class="line number4 index3 alt1"></div>
<div class="line number5 index4 alt2"><code class="bash functions">export</code> <code class="bash plain">LD_LIBRARY_PATH=lib64</code><code class="bash plain">/python3</code><code class="bash plain">.6</code><code class="bash plain">/lib-dynload</code></div>
<div class="line number6 index5 alt1"></div>
<div class="line number7 index6 alt2"><code class="bash functions">source</code> <code class="bash plain">bin</code><code class="bash plain">/activate</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="likes-and-labels-container" class="ViewPage_likesAndLabelsContainer_nyS">
<div></div>
</div>
]]></content:encoded>
					
					<wfw:commentRss>https://kshitij-kuls.com/2019/08/04/setting-up-virtual-environment-for-pyspark/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		
		<media:content url="https://0.gravatar.com/avatar/3eb7eaa9690ab587122cc92adb65d0b7?s=96&#38;d=identicon&#38;r=G" medium="image">
			<media:title type="html">kshitijk23</media:title>
		</media:content>
	</item>
	</channel>
</rss>
